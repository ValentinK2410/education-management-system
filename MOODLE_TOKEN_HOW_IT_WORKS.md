# Как работает токен Moodle: объяснение

## Основной принцип

**В Moodle токен всегда привязан к конкретному пользователю.** Это фундаментальная особенность архитектуры Moodle - токен не может существовать без пользователя.

## Как это работает в вашей системе

### 1. Один токен для всех запросов из Laravel

✅ **ДА, это правильный подход!** В вашей системе используется **один токен** для всех API-запросов из Laravel.

Посмотрите на код:

```php
// app/Services/MoodleApiService.php
public function __construct(?string $url = null, ?string $token = null)
{
    $this->url = rtrim($url ?? config('services.moodle.url', ''), '/');
    $this->token = $token ?? config('services.moodle.token', ''); // Один токен из .env
}

public function call(string $function, array $params = [])
{
    $params['wstoken'] = $this->token; // Все запросы используют один токен
    // ...
}
```

**Это означает:**
- Все запросы к Moodle API из Laravel идут от имени **одного пользователя Moodle**
- Этот пользователь указан при создании токена
- Токен хранится в `.env` как `MOODLE_TOKEN`

### 2. Почему нельзя создать токен "для всех пользователей"

❌ **Нельзя** создать токен, который будет работать от имени разных пользователей Moodle.

**Причина:**
- Токен = аутентификация конкретного пользователя Moodle
- Когда вы создаете токен, вы выбираете пользователя
- Moodle проверяет права этого пользователя при каждом запросе
- Это система безопасности Moodle

### 3. Решение: один токен с максимальными правами

✅ **Правильное решение:** Создать один токен для пользователя с ролью **Manager**, который имеет доступ ко всем курсам.

**Как это работает:**

```
┌─────────────────┐
│  Laravel App    │
│  (ваш сайт)     │
└────────┬────────┘
         │
         │ Все запросы используют
         │ один токен из .env
         │
         ▼
┌─────────────────┐
│  Moodle API     │
│  (REST API)     │
└────────┬────────┘
         │
         │ Токен привязан к
         │ пользователю "api_user"
         │
         ▼
┌─────────────────┐
│  Moodle User    │
│  "api_user"     │
│  Роль: Manager  │
└────────┬────────┘
         │
         │ Имеет доступ ко
         │ ВСЕМ курсам
         │
         ▼
┌─────────────────┐
│  Все курсы      │
│  Moodle         │
└─────────────────┘
```

## Практический пример

### Сценарий 1: Преподаватель смотрит задания своих студентов

1. **Преподаватель** заходит на `/admin/student-review` в Laravel
2. Laravel делает запрос к Moodle API используя **один токен** (из `.env`)
3. Moodle проверяет: "Этот токен принадлежит пользователю `api_user` с ролью Manager"
4. Moodle возвращает данные о всех курсах, к которым `api_user` имеет доступ
5. Laravel фильтрует данные и показывает только курсы этого преподавателя

**Важно:** Laravel фильтрует данные на своей стороне, но запрос к Moodle идет от имени `api_user`.

### Сценарий 2: Получение заданий конкретного курса

```php
// В Laravel
$moodleApi = new MoodleApiService();
$assignments = $moodleApi->getCourseAssignments($courseId);

// Запрос к Moodle:
// POST /webservice/rest/server.php
// wstoken=ваш_токен
// wsfunction=mod_assign_get_assignments
// courseids[0]=277
```

Moodle видит:
- Токен принадлежит пользователю `api_user`
- `api_user` имеет роль Manager
- Manager имеет доступ к курсу 277
- ✅ Возвращает задания

## Настройка для работы со всеми курсами

### Шаг 1: Создайте пользователя API

1. В Moodle: **Site administration** → **Users** → **Add a new user**
2. Создайте пользователя (например, `api_user`)
3. Назначьте ему роль **Manager** на уровне системы:
   - **Site administration** → **Users** → **Permissions** → **Assign system roles**
   - Найдите `api_user` и назначьте роль **Manager**

### Шаг 2: Создайте токен для этого пользователя

1. **Site administration** → **Plugins** → **Web services** → **Manage tokens**
2. **Create token**
3. Выберите пользователя `api_user`
4. Выберите сервис с максимальными правами
5. Скопируйте токен

### Шаг 3: Настройте в Laravel

В файле `.env`:
```env
MOODLE_TOKEN=ваш_токен_здесь
```

**Готово!** Теперь один токен работает для всех запросов.

## Важные моменты

### ✅ Что можно делать с одним токеном:

1. **Получать данные со всех курсов** (если пользователь токена имеет доступ)
2. **Создавать пользователей** в Moodle
3. **Зачислять студентов** на курсы
4. **Получать задания, тесты, форумы** со всех курсов
5. **Получать оценки** студентов

### ❌ Что НЕЛЬЗЯ делать:

1. **Имитировать разных пользователей** - все запросы идут от имени одного пользователя токена
2. **Получать данные от имени студента** - если нужны данные конкретного студента, запрашивайте их через API от имени `api_user`, но указывайте `userid` студента в параметрах

### Пример получения данных студента:

```php
// Получить попытки теста для конкретного студента
$moodleApi->call('mod_quiz_get_user_attempts', [
    'quizid' => 123,
    'userid' => 456  // ID студента в Moodle
]);
```

Запрос идет от имени `api_user`, но возвращает данные студента с ID 456.

## Безопасность

### Почему это безопасно:

1. **Токен хранится в `.env`** - не доступен публично
2. **Один пользователь API** - легче контролировать права
3. **Роль Manager** - имеет доступ только к курсам, но не к системным настройкам (если правильно настроено)
4. **Логирование** - все запросы логируются в Moodle

### Рекомендации:

1. ✅ Используйте отдельного пользователя для API (не администратора)
2. ✅ Регулярно проверяйте логи Moodle
3. ✅ Ограничьте IP-адреса, если возможно (в настройках токена)
4. ✅ Не коммитьте `.env` в git
5. ✅ Периодически обновляйте токен

## Часто задаваемые вопросы

### Вопрос: Можно ли использовать разные токены для разных преподавателей?

**Ответ:** Технически можно, но это усложнит систему. Лучше использовать один токен с ролью Manager, а фильтрацию данных делать в Laravel на основе `instructor_id`.

### Вопрос: Что если преподаватель не видит свои курсы?

**Ответ:** Проблема не в токене, а в том, что:
1. Пользователь токена (`api_user`) не зачислен на курс
2. Или курс не связан с преподавателем в Laravel (проверьте `Course::instructor_id`)

**Решение:** Зачислите `api_user` на все курсы с ролью Manager.

### Вопрос: Можно ли создать токен без привязки к пользователю?

**Ответ:** Нет, это невозможно в Moodle. Токен всегда привязан к пользователю - это архитектура Moodle.

### Вопрос: Как проверить, какой пользователь использует токен?

**Ответ:** 
1. Откройте `/admin/settings` в Laravel
2. В секции "Настройки Moodle" будет показана информация о пользователе токена
3. Или используйте API: `core_webservice_get_site_info` - вернет информацию о пользователе токена

## Итог

✅ **Один токен для всех - это правильный подход!**

- Токен привязан к одному пользователю Moodle
- Этот пользователь должен иметь роль Manager для доступа ко всем курсам
- Все запросы из Laravel идут от имени этого пользователя
- Фильтрация данных по преподавателям/студентам происходит в Laravel

Это стандартная практика для интеграции с Moodle API.
