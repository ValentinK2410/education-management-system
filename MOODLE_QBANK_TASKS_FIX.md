# Решение проблемы с задачами переноса вопросов в банк вопросов Moodle

## Описание проблемы

Если вы видите сообщение:

> "Специальные задачи \mod_qbank\task\transfer_question_categories и \mod_qbank\task\transfer_questions еще не завершены или закончилась неудачей. Вопросы, ранее созданные в других контекстах, пока не могут быть перенесены в общие банки вопросов курса. Управление вопросами и их совместное использование невозможны до завершения этих задач."

Это означает, что в Moodle есть фоновые задачи (cron tasks), которые должны перенести старые вопросы в новую систему банков вопросов (qbank), но эти задачи еще не выполнены или завершились с ошибкой.

## Причины проблемы

1. **Cron задачи Moodle не запускаются** - настроен ли cron для Moodle?
2. **Задачи выполняются слишком долго** - возможно, слишком много вопросов для переноса
3. **Ошибки в процессе переноса** - проблемы с правами доступа или поврежденными данными
4. **Недостаточно ресурсов** - не хватает памяти или времени выполнения

## Решение

### Шаг 1: Проверка настроек Cron

Убедитесь, что cron задачи Moodle настроены и запускаются регулярно.

**Для проверки cron в Moodle:**

1. Войдите в Moodle как администратор
2. Перейдите: **Site administration → Server → Scheduled tasks**
3. Найдите задачи:
   - `\mod_qbank\task\transfer_question_categories`
   - `\mod_qbank\task\transfer_questions`
4. Проверьте их статус:
   - **Last run** - когда последний раз выполнялась
   - **Next run** - когда будет следующее выполнение
   - **Status** - есть ли ошибки

### Шаг 2: Запуск задач вручную

Если задачи не выполняются автоматически, запустите их вручную:

1. В **Scheduled tasks** найдите нужные задачи
2. Нажмите кнопку **"Run now"** для каждой задачи
3. Дождитесь завершения выполнения

**Или через командную строку на сервере:**

```bash
# Перейдите в директорию Moodle
cd /path/to/moodle

# Запустите cron задачи
php admin/cli/cron.php
```

### Шаг 3: Проверка логов Moodle

Проверьте логи Moodle на наличие ошибок:

1. Перейдите: **Site administration → Reports → Logs**
2. Или проверьте файл логов на сервере: `moodledata/error.log`
3. Ищите ошибки, связанные с `qbank` или `transfer_question`

### Шаг 4: Увеличение лимитов выполнения

Если задачи прерываются из-за таймаута, увеличьте лимиты:

**В файле `config.php` Moodle добавьте:**

```php
// Увеличиваем время выполнения для cron задач
@ini_set('max_execution_time', '3600'); // 1 час
@ini_set('memory_limit', '512M');
```

**Или в `.htaccess` (если используется Apache):**

```apache
php_value max_execution_time 3600
php_value memory_limit 512M
```

**Или в `php.ini`:**

```ini
max_execution_time = 3600
memory_limit = 512M
```

### Шаг 5: Запуск задач через CLI с увеличенными лимитами

Если задачи все еще не выполняются, запустите их напрямую через CLI:

```bash
# Перейдите в директорию Moodle
cd /path/to/moodle

# Запустите конкретную задачу с увеличенными лимитами
php -d max_execution_time=3600 -d memory_limit=512M admin/cli/scheduled_task.php --execute="\mod_qbank\task\transfer_question_categories"
php -d max_execution_time=3600 -d memory_limit=512M admin/cli/scheduled_task.php --execute="\mod_qbank\task\transfer_questions"
```

### Шаг 6: Проверка прав доступа

Убедитесь, что пользователь, от имени которого запускается cron, имеет необходимые права:

1. Проверьте права на директорию `moodledata`
2. Убедитесь, что пользователь может записывать в базу данных
3. Проверьте права на файлы вопросов

### Шаг 7: Обновление Moodle

Если проблема сохраняется, возможно, нужно обновить Moodle:

1. Сделайте резервную копию базы данных и файлов
2. Перейдите: **Site administration → Notifications**
3. Проверьте наличие обновлений
4. Выполните обновление, если оно доступно

## Проверка решения

После выполнения шагов выше:

1. Перейдите: **Site administration → Scheduled tasks**
2. Проверьте, что задачи `transfer_question_categories` и `transfer_questions` выполнены успешно
3. Сообщение об ошибке должно исчезнуть из админ-панели Moodle
4. Проверьте, что управление вопросами работает корректно

## Дополнительная информация

### Настройка Cron для Moodle

Если cron не настроен, добавьте в crontab:

```bash
# Запуск cron задач Moodle каждые 5 минут
*/5 * * * * /usr/bin/php /path/to/moodle/admin/cli/cron.php >/dev/null 2>&1
```

Или используйте веб-интерфейс для настройки cron через:
**Site administration → Server → Scheduled tasks → Cron setup**

### Мониторинг выполнения задач

Для мониторинга выполнения задач можно использовать:

1. **Scheduled tasks** в админ-панели Moodle
2. Логи в `moodledata/error.log`
3. Таблицу `mdl_task_scheduled` в базе данных Moodle

## Если проблема не решается

Если после выполнения всех шагов проблема сохраняется:

1. Проверьте версию Moodle - возможно, нужна более новая версия
2. Проверьте совместимость плагинов с версией Moodle
3. Обратитесь в техподдержку Moodle или на форум сообщества
4. Проверьте, нет ли конфликтов с другими плагинами

## Важно

⚠️ **Не отключайте эти задачи вручную!** Они необходимы для корректной работы системы банков вопросов в Moodle. Если задачи отключены, включите их обратно в **Scheduled tasks**.
