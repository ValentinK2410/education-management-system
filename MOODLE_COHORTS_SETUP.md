# Настройка синхронизации глобальных групп (cohorts) из Moodle

## Проблема

При попытке синхронизации cohorts из Moodle возникает ошибка:
```
webservice_access_exception: Исключительная ситуация контроля доступа
```

Это означает, что токен API не имеет прав на выполнение функции `core_cohort_get_cohorts`.

## Решение

### Шаг 1: Войдите в Moodle как администратор

Откройте Moodle и войдите под учетной записью администратора.

### Шаг 2: Найдите используемую службу

1. Перейдите: **Настройки сайта → Плагины → Веб-сервисы → Внешние службы**
2. Найдите службу, которую использует ваш токен API
   - Обычно это служба типа "REST protocol" или "Mobile app"
   - Если не уверены, проверьте токен в разделе "Управление токенами"

### Шаг 3: Добавьте функции для работы с cohorts

1. Откройте службу для редактирования
2. В разделе **"Функции"** найдите и добавьте функции:
   - `core_cohort_get_cohorts` - для получения списка cohorts
   - `core_cohort_get_cohort_members` - для получения участников cohorts (обязательно для синхронизации студентов в группы)
3. Сохраните изменения

### Альтернативный способ (если служба не редактируется)

Если служба системная и не редактируется:

1. Перейдите: **Настройки сайта → Плагины → Веб-сервисы → Управление протоколами**
2. Выберите протокол **"REST"** и нажмите **"Изменить"**
3. В разделе **"Функции"** добавьте:
   - `core_cohort_get_cohorts`
   - `core_cohort_get_cohort_members`
4. Сохраните изменения

### Шаг 4: Проверьте права токена

1. Перейдите: **Настройки сайта → Плагины → Веб-сервисы → Управление токенами**
2. Найдите ваш токен API
3. Убедитесь, что токен использует правильную службу (с добавленной функцией)

### Шаг 5: Проверьте доступ

После добавления функции выполните быструю проверку:

```bash
php artisan moodle:check-cohorts-access
```

Команда покажет:
- ✅ Если доступ работает: "Доступ к core_cohort_get_cohorts РАБОТАЕТ" и список cohorts
- ❌ Если доступ отсутствует: детальные инструкции по исправлению

Или выполните полный тест:

```bash
php artisan moodle:test --course-id=1
```

В разделе "7. Тестирование получения глобальных групп (cohorts)..." должно появиться:
```
✅ Cohorts получены успешно: X
```

Затем можно запустить синхронизацию:

```bash
php artisan moodle:sync-cohorts
```

Или через веб-интерфейс:
- Перейдите в раздел "Синхронизация с Moodle"
- Нажмите кнопку "Синхронизировать глобальные группы (cohorts)"

## Важно: Синхронизация участников

При синхронизации cohorts система автоматически синхронизирует участников (студентов) в группы. Для этого необходимо:

1. **Функция `core_cohort_get_cohort_members`** должна быть добавлена в права токена (см. выше)
2. **Пользователи должны иметь `moodle_user_id`** - система сопоставляет участников cohorts с пользователями в системе деканата по полю `moodle_user_id`

Если у пользователей нет `moodle_user_id`, они не будут добавлены в группы при синхронизации.

## Дополнительные функции для cohorts (опционально)

Если планируете не только читать, но и создавать/редактировать cohorts, добавьте также:

- `core_cohort_create_cohorts` - создание cohorts
- `core_cohort_update_cohorts` - обновление cohorts
- `core_cohort_delete_cohorts` - удаление cohorts
- `core_cohort_add_cohort_members` - добавление участников
- `core_cohort_delete_cohort_members` - удаление участников

## Проверка доступных функций

Если функция `core_webservice_get_site_info` также не работает, это может означать:

1. Токен не настроен правильно
2. Служба не имеет базовых функций
3. Проблемы с правами пользователя токена

В этом случае проверьте:
- Правильность токена в `.env` файле (переменная `MOODLE_TOKEN`)
- Правильность URL Moodle в `.env` файле (переменная `MOODLE_URL`)
- Что токен активен и не истек срок действия

## Устранение неполадок

### Ошибка все еще возникает после добавления функции

1. Очистите кеш Moodle:
   - Перейдите: **Настройки сайта → Разработка → Очистить кеш**
   - Или выполните: `php admin/cli/purge_caches.php` на сервере Moodle

2. Проверьте, что токен использует правильную службу:
   - В настройках токена должна быть выбрана служба с функцией `core_cohort_get_cohorts`

3. Убедитесь, что пользователь токена имеет права администратора или достаточные права для работы с cohorts

### Cohorts не найдены

Если синхронизация проходит успешно, но cohorts не найдены:
- Проверьте, что в Moodle действительно созданы глобальные группы (cohorts)
- Перейдите: **Настройки сайта → Пользователи → Глобальные группы** в Moodle
- Убедитесь, что cohorts существуют и активны
