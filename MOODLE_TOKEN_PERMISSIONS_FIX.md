# Исправление проблемы с правами доступа токена Moodle API

## Проблема

При запросе заданий из Moodle API возвращается пустой массив `courses` с предупреждением:
```json
{
  "courses": [],
  "warnings": [
    {
      "item": "course",
      "itemid": 277,
      "warningcode": "2",
      "message": "User is not enrolled or does not have requested capability"
    }
  ]
}
```

## Причина

Токен Moodle API не имеет прав доступа к курсу. Это означает, что:
1. Пользователь, связанный с токеном, **не зачислен** на курс
2. Или пользователь **не имеет необходимых прав** (capabilities) для просмотра заданий

## Решение

### Вариант 1: Зачислить пользователя токена на курс (Рекомендуется)

1. Зайдите в Moodle как администратор
2. Найдите пользователя, связанного с токеном:
   - Site administration → Server → Web services → Manage tokens
   - Найдите ваш токен и посмотрите, какой пользователь его использует
3. Зачислите этого пользователя на курс:
   - Перейдите на курс (ID: 277 или другой)
   - Нажмите "Участники" (Participants)
   - Нажмите "Записать пользователей" (Enrol users)
   - Найдите пользователя токена и зачислите его с ролью **"Преподаватель"** или **"Менеджер"**

### Вариант 2: Создать токен для пользователя с правами преподавателя

1. Зайдите в Moodle как администратор
2. Найдите пользователя с ролью "Преподаватель" или "Менеджер", который зачислен на все нужные курсы
3. Создайте токен для этого пользователя:
   - Site administration → Server → Web services → Manage tokens
   - Нажмите "Create token"
   - Выберите пользователя
   - Выберите сервис (должен включать функцию `mod_assign_get_assignments`)
   - Сохраните токен
4. Обновите токен в `.env` файле Laravel:
   ```
   MOODLE_TOKEN=ваш_новый_токен
   ```

### Вариант 3: Настроить права роли пользователя токена

1. Зайдите в Moodle как администратор
2. Site administration → Users → Permissions → Define roles
3. Найдите роль пользователя токена (обычно "Web service" или "API user")
4. Убедитесь, что роль имеет следующие права:
   - `mod/assign:view` - просмотр заданий
   - `mod/assign:viewgrades` - просмотр оценок
   - `moodle/course:view` - просмотр курса
   - `moodle/course:viewhiddencourses` - просмотр скрытых курсов (если нужно)
5. Сохраните изменения

## Проверка прав доступа

После исправления проверьте:

1. Зайдите в Moodle под пользователем токена
2. Убедитесь, что вы видите курс в списке курсов
3. Откройте курс и убедитесь, что видите задания
4. Проверьте API запрос снова через функцию "Проверить данные в Moodle"

## Необходимые права (Capabilities) для mod_assign_get_assignments

Для успешного получения заданий через API токен должен иметь:

- `mod/assign:view` - просмотр заданий
- `mod/assign:viewgrades` - просмотр оценок (опционально, для получения оценок)
- `moodle/course:view` - просмотр курса
- `webservice/rest:use` - использование REST API
- Пользователь должен быть зачислен на курс

## Дополнительная информация

- Документация Moodle: https://docs.moodle.org/en/Web_services
- Функция API: `mod_assign_get_assignments`
- Требуемый контекст: курс (course context)
