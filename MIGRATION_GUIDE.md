# Руководство по безопасному применению миграций

## Общие принципы

Применение миграций к базе данных с реальными данными требует осторожности. Следуйте этим рекомендациям для безопасного обновления структуры базы данных.

## Процесс применения миграций

### 1. Подготовка

**Перед применением миграций на продакшене:**

1. **Создайте резервную копию:**
   ```bash
   php artisan db:backup
   # или
   ./backup-database.sh
   ```

2. **Проверьте целостность данных:**
   ```bash
   php artisan db:check-integrity
   ```

3. **Протестируйте миграции на тестовой БД:**
   ```bash
   # Создайте тестовую копию БД
   cp database/database.sqlite database/database_test.sqlite
   
   # Примените миграции к тестовой БД
   DB_DATABASE=database/database_test.sqlite php artisan migrate
   
   # Проверьте целостность
   DB_DATABASE=database/database_test.sqlite php artisan db:check-integrity
   ```

### 2. Применение миграций

**На продакшене:**

```bash
# Применить все новые миграции
php artisan migrate

# Или с подтверждением
php artisan migrate --force
```

**Важно:**
- Применяйте миграции в период низкой нагрузки
- Уведомите пользователей о возможных кратковременных перебоях
- Мониторьте логи во время применения

### 3. Проверка после применения

```bash
# Проверьте целостность данных
php artisan db:check-integrity

# Проверьте статус миграций
php artisan migrate:status

# Проверьте логи на ошибки
tail -f storage/logs/laravel.log
```

## Откат миграций

### Если что-то пошло не так

1. **Откатите последние миграции:**
   ```bash
   # Откатить одну миграцию
   php artisan migrate:rollback --step=1
   
   # Откатить несколько миграций
   php artisan migrate:rollback --step=3
   ```

2. **Восстановите из резервной копии:**
   ```bash
   # См. BACKUP_RESTORE.md
   ```

3. **Проверьте целостность:**
   ```bash
   php artisan db:check-integrity
   ```

## Типы миграций

### Безопасные миграции

Эти миграции безопасны для применения на продакшене:

- Добавление новых таблиц
- Добавление новых полей (nullable)
- Добавление индексов
- Добавление внешних ключей (если данные корректны)

### Осторожные миграции

Требуют особой осторожности:

- Изменение типов данных
- Удаление полей
- Изменение ограничений (NOT NULL, UNIQUE)
- Изменение внешних ключей

### Опасные миграции

Требуют обязательного резервного копирования:

- Удаление таблиц
- Удаление полей с данными
- Изменение структуры критических таблиц
- Массовые изменения данных

## Рекомендации по написанию миграций

### 1. Всегда создавайте метод down()

```php
public function down(): void
{
    Schema::table('users', function (Blueprint $table) {
        $table->dropColumn('deleted_at');
    });
}
```

### 2. Используйте транзакции для массовых операций

```php
public function up(): void
{
    DB::transaction(function () {
        // Ваши изменения
    });
}
```

### 3. Проверяйте существование перед изменением

```php
public function up(): void
{
    Schema::table('users', function (Blueprint $table) {
        if (!Schema::hasColumn('users', 'deleted_at')) {
            $table->softDeletes();
        }
    });
}
```

### 4. Используйте условные изменения

```php
public function up(): void
{
    Schema::table('users', function (Blueprint $table) {
        if (Schema::hasColumn('users', 'old_field')) {
            $table->renameColumn('old_field', 'new_field');
        }
    });
}
```

## Тестирование миграций

### Запуск тестов

```bash
php artisan test --filter MigrationTest
```

### Что проверяют тесты

- Применение всех миграций
- Наличие необходимых полей и таблиц
- Возможность отката миграций
- Целостность данных после миграций
- Наличие необходимых индексов

## Частые проблемы и решения

### Проблема: Миграция не может быть применена

**Решение:**
1. Проверьте логи ошибок
2. Убедитесь, что предыдущие миграции применены
3. Проверьте целостность данных
4. При необходимости откатите и примените заново

### Проблема: Нарушение внешних ключей

**Решение:**
1. Проверьте данные перед применением миграции
2. Исправьте некорректные данные
3. Примените миграцию снова

### Проблема: Потеря данных

**Решение:**
1. Немедленно откатите миграцию
2. Восстановите из резервной копии
3. Проанализируйте причину потери данных
4. Исправьте миграцию и протестируйте на тестовой БД

## Чеклист перед применением миграций

- [ ] Резервная копия создана
- [ ] Миграции протестированы на тестовой БД
- [ ] Целостность данных проверена
- [ ] Метод `down()` реализован
- [ ] Пользователи уведомлены (если требуется)
- [ ] Период низкой нагрузки выбран
- [ ] Логи мониторятся
- [ ] План отката подготовлен

## Автоматизация

### Добавление проверки целостности после миграций

В `app/Providers/AppServiceProvider.php` можно добавить автоматическую проверку:

```php
public function boot(): void
{
    // После применения миграций проверяем целостность
    Artisan::after('migrate', function () {
        Artisan::call('db:check-integrity');
    });
}
```

## Дополнительные ресурсы

- [DATA_PROTECTION.md](DATA_PROTECTION.md) - Общее руководство по защите данных
- [BACKUP_RESTORE.md](BACKUP_RESTORE.md) - Инструкции по резервному копированию
- [Laravel Migrations Documentation](https://laravel.com/docs/migrations)

