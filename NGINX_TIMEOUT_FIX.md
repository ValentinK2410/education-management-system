# Исправление тайм-аута 504 Gateway Timeout при синхронизации Moodle

## Проблема

При выполнении полной синхронизации Moodle (`/admin/moodle-sync/all`) возникает ошибка **504 Gateway Timeout** от nginx. Это происходит потому, что синхронизация всех курсов и записей студентов может занимать много времени, превышая стандартные тайм-ауты nginx (обычно 60 секунд).

## Решение

### 1. Увеличение тайм-аутов в Nginx (на сервере)

Выполните на сервере следующий скрипт:

```bash
cd /var/www/www-root/data/www/dean.russianseminary.org
chmod +x scripts/fix-nginx-timeout.sh
sudo ./scripts/fix-nginx-timeout.sh
```

Скрипт автоматически:
- Найдет конфигурационный файл Nginx
- Создаст резервную копию
- Увеличит тайм-ауты до 600 секунд (10 минут)
- Проверит синтаксис и перезагрузит Nginx

### 2. Ручная настройка (если скрипт не работает)

Если скрипт не работает, выполните настройку вручную:

#### 2.1. Найдите конфигурационный файл Nginx

```bash
# Обычно это один из следующих файлов:
/etc/nginx/sites-available/dean.russianseminary.org
/etc/nginx/sites-available/default
```

#### 2.2. Добавьте/обновите настройки тайм-аутов

В блоке `location ~ \.php$` добавьте или обновите следующие строки:

```nginx
location ~ \.php$ {
    # ... существующие настройки ...
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock; # или другой путь
    
    # Добавьте или обновите эти строки:
    fastcgi_read_timeout 600;
    fastcgi_send_timeout 600;
    fastcgi_connect_timeout 600;
    
    # ... остальные настройки ...
}
```

#### 2.3. Также добавьте в основной конфиг (опционально)

В файле `/etc/nginx/nginx.conf` в блоке `http {` добавьте:

```nginx
http {
    # ... существующие настройки ...
    
    proxy_read_timeout 600;
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    
    # ... остальные настройки ...
}
```

#### 2.4. Проверьте синтаксис и перезагрузите Nginx

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 3. Увеличение тайм-аутов в PHP (уже настроено в коде)

Код уже настроен на увеличение времени выполнения PHP до 10 минут для полной синхронизации и 5 минут для синхронизации курсов/записей. Это делается автоматически в контроллере через `set_time_limit()`.

### 4. Проверка настройки PHP (опционально)

Если нужно увеличить глобально, отредактируйте `/etc/php/8.2/fpm/php.ini`:

```ini
max_execution_time = 600
```

И перезапустите PHP-FPM:

```bash
sudo systemctl restart php8.2-fpm
```

## Альтернативное решение: Асинхронная синхронизация через очереди

Для очень больших объемов данных рекомендуется использовать асинхронную синхронизацию через Laravel Queues. Это позволит выполнять синхронизацию в фоне без ограничений по времени HTTP-запроса.

### Настройка очередей:

1. Настройте драйвер очередей в `.env`:
```env
QUEUE_CONNECTION=database
```

2. Запустите миграции для таблиц очередей:
```bash
php artisan queue:table
php artisan migrate
```

3. Создайте Job для синхронизации (требует дополнительной разработки)

4. Запустите worker:
```bash
php artisan queue:work
```

## Проверка работы

После настройки тайм-аутов попробуйте выполнить синхронизацию снова:

1. Откройте `/admin/moodle-sync`
2. Нажмите "Полная синхронизация"
3. Дождитесь завершения (может занять несколько минут)

Если проблема сохраняется, проверьте логи:

```bash
# Логи Nginx
sudo tail -f /var/log/nginx/error.log

# Логи Laravel
tail -f storage/logs/laravel.log

# Логи PHP-FPM
sudo tail -f /var/log/php8.2-fpm.log
```

## Рекомендации

- Для больших объемов данных используйте синхронизацию отдельных курсов вместо полной синхронизации
- Рассмотрите возможность использования cron-задач для автоматической синхронизации в фоне
- Мониторьте время выполнения синхронизации и при необходимости увеличьте тайм-ауты еще больше
