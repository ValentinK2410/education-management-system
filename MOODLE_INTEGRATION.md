# Интеграция с Moodle

## Описание

Система автоматически синхронизирует пользователей с Moodle при их создании в Laravel приложении. Когда пользователь регистрируется через форму регистрации или создается администратором, он автоматически создается в Moodle с теми же учетными данными.

## Настройка

### 1. Настройка переменных окружения

Добавьте следующие переменные в файл `.env`:

```env
# Moodle Integration
MOODLE_URL=https://class.dekan.pro
MOODLE_TOKEN=your_moodle_token_here
MOODLE_SYNC_ENABLED=true
```

### 2. Получение токена Moodle

**ВАЖНО**: Токен Moodle необходим для работы синхронизации. Без него система не сможет подключиться к Moodle API.

#### Шаги для получения токена:

1. **Войдите в Moodle как администратор**
   - Откройте `https://class.dekan.pro` (или ваш URL Moodle)
   - Войдите под учетной записью администратора

2. **Включите веб-сервисы (если еще не включены)**
   - Перейдите: **Site administration** → **Advanced features**
   - Установите галочку **Enable web services**
   - Сохраните изменения

3. **Настройте протокол REST**
   - Перейдите: **Site administration** → **Plugins** → **Web services** → **Manage protocols**
   - Убедитесь, что протокол **REST** включен

4. **Создайте токен**
   - Перейдите: **Site administration** → **Plugins** → **Web services** → **Manage tokens**
   - Нажмите **Create token**
   - Выберите пользователя с правами администратора
   - Выберите сервис (или создайте новый с нужными правами)
   - Нажмите **Create token**
   - **ВАЖНО**: Скопируйте токен сразу, он больше не будет показан!

5. **Добавьте токен в .env файл**
   ```env
   MOODLE_TOKEN=ваш_токен_здесь
   ```

6. **Проверьте права токена**
   Убедитесь, что токен имеет права на следующие функции:
   - `core_user_create_users` - создание пользователей
   - `core_user_get_users_by_field` - получение пользователей
   - `core_user_update_users` - обновление пользователей
   - `core_course_get_courses` - получение списка курсов
   - `core_enrol_get_enrolled_users` - получение записанных пользователей
   - `core_course_get_contents` - получение содержимого курса
   - `mod_assign_get_assignments` - получение заданий курса
   - `mod_assign_get_submissions` - получение сдач заданий
   - `mod_assign_get_grades` - получение оценок

#### Проверка конфигурации

После настройки токена выполните команду для проверки конфигурации:

```bash
php artisan moodle:check-config
```

Эта команда покажет:
- Статус настройки `MOODLE_URL`
- Статус настройки `MOODLE_TOKEN`
- Результат попытки подключения к Moodle API
- Полезные подсказки при обнаружении проблем

### 3. Выполнение миграции

Выполните миграцию для добавления поля `moodle_user_id` в таблицу пользователей:

```bash
php artisan migrate
```

## Как это работает

1. **Создание пользователя**: Когда пользователь регистрируется через форму (`AuthController::register`) или создается администратором (`UserController::store`), создается событие `UserCreated`.

2. **Синхронизация**: Слушатель `SyncUserToMoodle` автоматически обрабатывает событие и:
   - Проверяет, существует ли пользователь в Moodle по email
   - Если пользователь существует, сохраняет его ID в поле `moodle_user_id`
   - Если пользователь не существует, создает его в Moodle с модифицированным паролем (добавляются специальные символы и цифры для соответствия требованиям Moodle)
   - Сохраняет ID созданного пользователя Moodle в поле `moodle_user_id`

3. **Модификация пароля**: Пароль автоматически модифицируется для соответствия требованиям Moodle:
   - Если отсутствуют специальные символы (*, -, #), добавляется дефис (-)
   - Если отсутствуют цифры, добавляется цифра 1

## Структура файлов

- `app/Services/MoodleApiService.php` - сервис для работы с Moodle REST API
- `app/Events/UserCreated.php` - событие создания пользователя
- `app/Listeners/SyncUserToMoodle.php` - слушатель для синхронизации с Moodle
- `config/services.php` - конфигурация Moodle
- `database/migrations/2024_12_22_000001_add_moodle_user_id_to_users_table.php` - миграция для добавления поля `moodle_user_id`

## Логирование

Все операции синхронизации логируются в файл `storage/logs/laravel.log`. Вы можете отслеживать:
- Успешное создание пользователей в Moodle
- Ошибки при синхронизации
- Пропуск синхронизации (если отключена или не настроена)

## Отключение синхронизации

Чтобы временно отключить синхронизацию с Moodle, установите в `.env`:

```env
MOODLE_SYNC_ENABLED=false
```

## Требования

- PHP 8.2+
- Laravel 12.0+
- Настроенный Moodle с включенными веб-сервисами
- Токен Moodle с правами на создание и обновление пользователей

