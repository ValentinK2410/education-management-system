# Инструкция по созданию токена Moodle без ограничений

## Пошаговая инструкция

### Шаг 1: Включение веб-сервисов

1. Войдите в Moodle как администратор
2. Перейдите: **Site administration** → **Advanced features**
3. Установите галочку **Enable web services**
4. Нажмите **Save changes**

### Шаг 2: Настройка протокола REST

1. Перейдите: **Site administration** → **Plugins** → **Web services** → **Manage protocols**
2. Убедитесь, что протокол **REST** включен (галочка установлена)
3. Если REST не включен, установите галочку и сохраните

### Шаг 3: Создание внешнего сервиса (External Service)

Для токена без ограничений нужно создать внешний сервис с максимальными правами:

1. Перейдите: **Site administration** → **Plugins** → **Web services** → **External services**
2. Нажмите **Add** (Добавить)
3. Заполните форму:
   - **Name**: `Full Access API` (или любое другое название)
   - **Short name**: `full_access_api` (уникальное короткое имя)
   - **Enabled**: ✅ (включено)
   - **Required capability**: оставьте пустым (для максимального доступа)
   - **Restricted users**: ❌ (не ограничивать пользователей)
   - **Download files**: ✅ (разрешить загрузку файлов)
   - **Upload files**: ✅ (разрешить загрузку файлов)
4. Нажмите **Save changes**

### Шаг 4: Добавление функций в сервис

1. После создания сервиса нажмите на его название
2. Перейдите на вкладку **Functions** (Функции)
3. Нажмите **Add functions** (Добавить функции)
4. В поле поиска введите `mod_assign_get_assignments` и добавьте
5. Добавьте другие необходимые функции:
   - `mod_quiz_get_quizzes_by_courses`
   - `mod_quiz_get_user_attempts`
   - `mod_quiz_get_user_best_grade`
   - `mod_forum_get_forums_by_courses`
   - `mod_forum_get_forum_discussions`
   - `mod_forum_get_discussion_posts`
   - `core_course_get_contents`
   - `core_course_get_courses`
   - `core_enrol_get_enrolled_users`
   - `core_user_get_users_by_field`
   - `core_webservice_get_site_info`
   - И другие необходимые функции

**Или для максимального доступа:**
- В поле поиска введите `*` (звездочка) и нажмите поиск
- Выберите все функции или используйте кнопку "Select all"
- Нажмите **Add functions**

### Шаг 5: Создание пользователя для токена (рекомендуется)

Для безопасности лучше создать отдельного пользователя для API:

1. Перейдите: **Site administration** → **Users** → **Accounts** → **Add a new user**
2. Заполните обязательные поля:
   - **Username**: `api_user` (или другое имя)
   - **Password**: создайте надежный пароль
   - **First name**: `API`
   - **Surname**: `User`
   - **Email**: `api@yourdomain.com`
3. Нажмите **Create user**

### Шаг 6: Назначение роли пользователю

1. Перейдите: **Site administration** → **Users** → **Permissions** → **Assign system roles**
2. Найдите пользователя API и назначьте ему роль **Manager** (Менеджер)
   - Это даст максимальные права на всех курсах

**Или для доступа к конкретным курсам:**
1. Откройте нужный курс
2. Перейдите: **Participants** → **Enrol users**
3. Найдите пользователя API и зачислите его с ролью **Manager** или **Course creator**

### Шаг 7: Создание токена

1. Перейдите: **Site administration** → **Plugins** → **Web services** → **Manage tokens**
2. Нажмите **Create token** (Создать токен)
3. Заполните форму:
   - **User**: выберите пользователя API (созданного на шаге 5)
   - **Service**: выберите созданный сервис "Full Access API"
   - **IP restriction**: оставьте пустым (для доступа с любого IP)
   - **Valid until**: оставьте пустым (токен без срока действия)
4. Нажмите **Save changes**
5. **ВАЖНО**: Скопируйте созданный токен сразу - он больше не будет показан!

### Шаг 8: Настройка в Laravel

1. Откройте файл `.env` на сервере Laravel
2. Обновите переменные:
   ```
   MOODLE_URL=https://class.russianseminary.org
   MOODLE_TOKEN=ваш_новый_токен_здесь
   ```
3. Очистите кэш Laravel:
   ```bash
   php artisan config:clear
   php artisan cache:clear
   ```

## Альтернативный способ: Токен для существующего пользователя

Если вы хотите использовать токен для существующего пользователя (например, администратора):

1. Убедитесь, что пользователь имеет роль **Manager** или **Administrator** на уровне системы
2. Создайте токен для этого пользователя (шаг 7)
3. Убедитесь, что пользователь зачислен на все нужные курсы

## Проверка токена

После создания токена проверьте его работу:

1. Откройте страницу `/admin/settings` в Laravel
2. В секции "Настройки Moodle" должна отображаться информация о токене
3. Должен быть статус "Токен работает корректно"
4. Должна отображаться информация о пользователе токена

## Решение проблем

### Ошибка "User is not enrolled or does not have requested capability"

**Решение:**
1. Зайдите в Moodle под пользователем токена
2. Убедитесь, что пользователь видит нужные курсы
3. Если курсы не видны, зачислите пользователя на курсы с ролью "Manager" или "Course creator"
4. Проверьте права роли: **Site administration** → **Users** → **Permissions** → **Define roles**
5. Убедитесь, что роль имеет права:
   - `mod/assign:view`
   - `mod/quiz:view`
   - `mod/forum:view`
   - `moodle/course:view`

### Токен не работает

**Проверьте:**
1. Токен скопирован полностью (без пробелов)
2. URL Moodle указан правильно (с `https://`)
3. Веб-сервисы включены в Moodle
4. Протокол REST включен
5. Токен не истек (если был указан срок действия)

## Безопасность

⚠️ **Важно:**
- Токен без ограничений дает полный доступ к Moodle API
- Храните токен в безопасности (файл `.env` не должен быть доступен публично)
- Не коммитьте файл `.env` в git
- Регулярно проверяйте логи Moodle на подозрительную активность
- Используйте отдельного пользователя для API, а не администратора
