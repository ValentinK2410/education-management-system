# Руководство по защите данных

## Обзор

Система управления образованием включает комплексные механизмы защиты данных для предотвращения потери информации при развитии и обновлении системы.

## Основные механизмы защиты

### 1. Soft Deletes (Мягкое удаление)

Все критические модели используют мягкое удаление вместо физического. При удалении записи она помечается как удаленная (поле `deleted_at`), но остается в базе данных.

**Защищенные модели:**
- `User` - пользователи системы
- `Course` - курсы обучения
- `Program` - образовательные программы
- `Institution` - учебные заведения
- `Payment` - платежи
- `Certificate` - сертификаты
- `EnrollmentHistory` - история зачислений

**Использование:**
```php
// Мягкое удаление
$user->delete(); // Запись помечается как удаленная

// Восстановление
$user->restore();

// Получение только удаленных записей
User::onlyTrashed()->get();

// Получение всех записей включая удаленные
User::withTrashed()->get();
```

### 2. Версионирование данных (Audit Trail)

Система автоматически сохраняет версии записей перед каждым обновлением, что позволяет отслеживать изменения и откатывать их при необходимости.

**Модели с версионированием:**
- `User`
- `Course`
- `Program`
- `Institution`
- `Payment`

**Использование:**
```php
// Получить все версии записи
$user->versions;

// Получить последнюю версию
$user->latestVersion();

// Восстановить из конкретной версии
$user->restoreFromVersion($versionId);

// Откатиться к предыдущей версии
$user->rollbackToPrevious();
```

### 3. Проверка зависимостей перед удалением

Перед удалением записи система проверяет наличие связанных данных и предотвращает удаление, если есть зависимости.

**Использование:**
```php
// Проверить, можно ли удалить запись
$canDelete = $user->canBeDeleted();

if (!$canDelete['can_delete']) {
    // Показать предупреждение с зависимостями
    echo $canDelete['message'];
    print_r($canDelete['dependencies']);
}
```

### 4. Логирование критических операций

Все критические операции (создание, обновление, удаление) автоматически логируются в таблицу `activity_logs`.

**Информация в логах:**
- Кто выполнил действие (user_id)
- Что было изменено (old_values, new_values)
- Когда выполнено (created_at)
- IP адрес и User Agent
- Описание действия

**Использование:**
```php
// Получить логи активности для модели
$user->activityLogs;

// Получить логи по действию
ActivityLog::forAction('deleted')->get();

// Получить логи пользователя
ActivityLog::forUser($userId)->get();
```

## Рекомендации по работе с данными

### Перед применением миграций

1. **Создайте резервную копию:**
   ```bash
   php artisan db:backup
   # или
   ./backup-database.sh
   ```

2. **Проверьте целостность данных:**
   ```bash
   php artisan db:check-integrity
   ```

3. **Протестируйте миграции на тестовой БД:**
   ```bash
   php artisan migrate:fresh --seed
   php artisan db:check-integrity
   ```

### При удалении записей

1. Система автоматически проверяет зависимости
2. Если есть зависимости, удаление блокируется с сообщением
3. Используйте Soft Deletes - записи не удаляются физически
4. Все операции логируются в `activity_logs`

### При обновлении записей

1. Версия автоматически сохраняется перед обновлением
2. Можно откатить изменения через `rollbackToPrevious()`
3. Все изменения логируются

## Восстановление данных

### Восстановление из резервной копии

См. [BACKUP_RESTORE.md](BACKUP_RESTORE.md)

### Восстановление удаленных записей

```php
// Восстановить конкретную запись
$user = User::onlyTrashed()->find($id);
$user->restore();

// Восстановить из версии
$user->restoreFromVersion($versionId);
```

## Мониторинг и аудит

### Просмотр логов активности

```php
// Все логи
ActivityLog::latest()->paginate(50);

// Логи конкретной модели
$user->activityLogs;

// Логи по действию
ActivityLog::forAction('deleted')->get();
```

### Проверка целостности данных

Регулярно выполняйте проверку целостности:
```bash
php artisan db:check-integrity
```

## Безопасность

- Все критические операции требуют подтверждения
- Используются транзакции для атомарности операций
- Логирование всех действий с указанием пользователя и IP
- Защита от каскадного удаления связанных данных

