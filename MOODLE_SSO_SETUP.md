# Настройка SSO для автоматического входа в Moodle

## Описание

Система поддерживает автоматический вход в Moodle без ввода логина и пароля через Single Sign-On (SSO).

## Требования

1. Пользователь должен быть авторизован в Laravel приложении
2. У пользователя должен быть `moodle_user_id` в базе данных
3. На стороне Moodle должен быть установлен и настроен плагин для обработки SSO токенов

## Настройка на стороне Laravel

Настройки уже выполнены автоматически. Система:
- Генерирует зашифрованный токен SSO для пользователя
- Перенаправляет на Moodle с токеном и данными пользователя
- Автоматически находит `moodle_user_id` если он отсутствует

## Настройка на стороне Moodle

### Вариант 1: Использование готового скрипта (рекомендуется)

1. Скопируйте файл `moodle-sso-from-laravel.php` в корневую директорию Moodle:
   ```bash
   # На сервере Moodle
   cd /var/www/www-root/data/www/class.russianseminary.org
   # Скопируйте файл из Laravel проекта
   ```

2. Отредактируйте файл `moodle-sso-from-laravel.php`:
   - Укажите правильный `$laravel_url` (URL вашего Laravel приложения)
   - Укажите `$laravel_sso_secret` (APP_KEY из Laravel .env файла, без префикса `base64:`)

3. Убедитесь, что файл имеет правильные права доступа:
   ```bash
   chmod 644 moodle-sso-from-laravel.php
   ```

4. Проверьте работу:
   - Перейдите по адресу: `https://class.russianseminary.org/moodle-sso-from-laravel.php`
   - Должна появиться ошибка "Недостаточно параметров" (это нормально, так как скрипт вызывается из Laravel)

### Вариант 2: Использование плагина SSO

1. Установите плагин для SSO авторизации в Moodle (например, `auth_sso` или аналогичный)
2. Настройте плагин для приема токенов от Laravel приложения
3. Убедитесь, что плагин проверяет токен и автоматически авторизует пользователя

### Вариант 3: Создание кастомного плагина (для разработчиков)

Создайте плагин в Moodle, который будет:
1. Принимать токен SSO от Laravel
2. Расшифровывать токен и проверять его валидность
3. Автоматически авторизовывать пользователя по `moodle_user_id` или `email`

Пример структуры плагина:
```
auth/sso/
├── version.php
├── auth.php
└── lib.php
```

## Использование

После настройки плагина на стороне Moodle:

1. Пользователь нажимает кнопку "Перейти в виртуальный класс" в header
2. Система автоматически генерирует токен SSO
3. Пользователь перенаправляется на Moodle с токеном
4. Moodle плагин обрабатывает токен и автоматически авторизует пользователя
5. Пользователь попадает в Moodle без необходимости вводить логин и пароль

## Безопасность

- Токены SSO действительны только 5 минут
- Токены зашифрованы с использованием Laravel Crypt
- Токены содержат информацию о пользователе и время истечения
- Каждый токен уникален и не может быть повторно использован

## Отладка

Если SSO не работает:

1. Проверьте логи Laravel: `storage/logs/laravel.log`
2. Ищите записи с префиксом `Moodle SSO:`
3. Убедитесь, что:
   - Пользователь авторизован в Laravel
   - У пользователя есть `moodle_user_id`
   - Moodle URL настроен правильно в `.env`
   - Плагин SSO установлен и настроен в Moodle

## Альтернативный подход без плагина

Если установка плагина невозможна, можно использовать альтернативный подход:

1. Использовать Moodle Web Services для создания токена авторизации пользователя
2. Перенаправить пользователя на специальный URL Moodle с токеном
3. Moodle автоматически авторизует пользователя по токену

Этот подход требует дополнительной настройки на стороне Moodle и может быть менее безопасным.
