# Команды для обновления на сервере
# Выполняйте по порядку

cd /var/www/www-root/data/www/m.dekan.pro

# Обновление кода из Git
git pull origin main

# Определение пользователя PHP-FPM
WORKER_USER=$(ps aux | grep "php-fpm: pool" | grep -v grep | head -1 | awk '{print $1}')
if [ -z "$WORKER_USER" ]; then
    if id "www-root" &>/dev/null; then
        WORKER_USER="www-root"
    else
        WORKER_USER="www-data"
    fi
fi
echo "Пользователь PHP-FPM: $WORKER_USER"

# Очистка старых скомпилированных представлений и кеша
rm -rf storage/framework/views/*
rm -rf storage/framework/cache/*

# Создание необходимых директорий
mkdir -p storage/framework/views
mkdir -p storage/framework/cache
mkdir -p storage/framework/sessions
mkdir -p storage/logs
mkdir -p bootstrap/cache

# Установка прав доступа
chown -R $WORKER_USER:$WORKER_USER storage
chown -R $WORKER_USER:$WORKER_USER bootstrap/cache
chmod -R 775 storage
chmod -R 775 bootstrap/cache
chmod 775 storage/framework/views
chown $WORKER_USER:$WORKER_USER storage/framework/views

# Очистка кеша Laravel
php artisan view:clear
php artisan config:clear
php artisan cache:clear

# Перезапуск PHP-FPM (если нужно)
# Проверка и перезапуск PHP 8.4
if systemctl is-active --quiet php84-php-fpm; then
    systemctl restart php84-php-fpm
fi

# Проверка и перезапуск PHP 8.3
if systemctl is-active --quiet php8.3-fpm; then
    systemctl restart php8.3-fpm
fi

echo "✅ Обновление завершено!"
